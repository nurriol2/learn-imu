# Flicker Noise Simulation

Noise simulation for *Learn IMU* closely follows the implementation from K. Jerath [1].

While trying to translate the MATLAB source to Python, I found it difficult to understand the flicker noise simulation. 

The file `Flicker_noise.m` isolates the flicker noise simulation section of [1] and experiments with the output to better understand the process. My own thoughts are recorded directly in the source file. I will reiterate the main points here.

# Methods for Simulating Flicker Noise

Accompanying the MATLAB files is a presentation [2] from K. Jerath. Slide 10 of [2] shows a method for generating flicker noise via a stochastic differential equation. As of 18-06-21, this method is how flicker noise is simulated for *Learn IMU*. 

The flicker noise generated using the differential equation method has been shown to generate the correct 1/f PSD in [`exploratory_degree_of_psd_plot.ipynb`](https://github.com/nurriol2/learn-imu/blob/ft-noise-generation/notebooks/exploratory_degree_of_psd_plot.ipynb).

While this method works, it does not allow for very much customization of the noise parameters. Specifically with respect to the coefficient typically found on a data sheet. 

The method used to generate flicker noise in [1] depends on shaping a white noise *N(&mu;,&sigma;)* series into the desired form.

This approach works well for defining features of the noise such as noise coefficient and standard deviation of noise.

## Initial Confusion

The following section from [1] is where my confusion began.

```
x_FN = zeros(length(numTerms),time*fs+1);

...

x_FN(1:numTerms) = 0;
wNew = B.*w_FN;
% Generate the flicker noise
for(count = (numTerms+1):1:time*fs)
    x_FN(count+1) = -a(1,2:end)*(fliplr(x_FN(count-numTerms:count-1)))' + wNew(count);

end
```

At the start of the above snippet, an array of 0s `x_FN` is initialized according to some simulation parameters. Within the `for` loop, we multiply filter coefficients by elements of `x_FN`. *But the elements of `x_FN` are all 0*. 

It was my understanding that from this point forward `x_FN` would leave the `for` as the sum of many 0s and many draws from *N(&mu;,&sigma;)*. In other words, `x_FN` *would be exactly N(&mu;,&sigma;)*

If this result was true, then concurrently plotting `x_FN` and the exact *N(&mu;,&sigma;)* samples should produce the same plot. The plotting code in `Flicker_noise.m` makes a single figure with these 2 plots. 

The scaling of the resulting plots was different by an order of magnitude and some distinct peaks were changed between the plots. This was good evidence that my initial understanding was incorrect. 

## Understanding Each Loop

In order to understand better what was happening each run of the `for` loop, I greatly reduced the size of the simulation parameters.

I noted that it's possible doing so would violate some assumptions of the synthesis algorithm, but I do not believe that is the case.

I took advantage of the much smaller series size by explicitly following which values were being drawn from *N(&mu;, &sigma;)* and how `x_FN` was changing. I noted that since `x_FN` is mostly 0s in the earliest runs of the `for` loop, the values were simply being swapped in-place by *N(&mu;, &sigma;)* samples. However, as the runs continue fewer elements of `x_FN` are 0. So, the white noise samples are being compounded and used for elements of `x_FN`.

I think this process is the "shaping" discussed at length in noise synthesis literature. The original samples from *N(&mu;, &sigma;)* are being adjusted according to filter coefficients and subsequent *N(&mu;, &sigma;)* samples.

The shaping is clear by comparing the plots generated by `Flicker_noise.m`. 

![Figure 1](/Users/nikourriola/Desktop/learn-imu/notebooks/exploratory-flicker-noise/figure_1.png)

The right plot is the original white noise sequence. Clearly the left plot is related, but differs slightly for some points.

---

# References
1.  Kshitij Jerath (2021). Allan variance analysis of simulated sensor noise (https://www.mathworks.com/matlabcentral/fileexchange/64590-allan-variance-analysis-of-simulated-sensor-noise), MATLAB Central File Exchange. Retrieved June 18, 2021.

2. TODO:  Include ref. to presentation. UMASS Lowell has an IT outage *(03:46:19-18-06-21)*